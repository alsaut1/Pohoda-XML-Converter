<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Pohoda XML Converter</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 50px auto; 
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; text-align: center; }
        .file-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px dashed #3498db;
            border-radius: 5px;
            text-align: center;
        }
        button {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }
        button:hover { background: #2980b9; }
        .log {
            background: #2c3e50;
            color: #2ecc71;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèïÔ∏è Pohoda XML Converter</h1>
        <p>–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä CSV —Ñ–∞–π–ª–æ–≤ –∫–µ–º–ø–∏–Ω–≥–∞ –≤ XML —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º—ã Pohoda</p>
        
        <div class="file-input">
            <input type="file" id="fileInput" accept=".txt,.csv">
            <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª paste.txt –∏–ª–∏ CSV —Ñ–∞–π–ª</p>
        </div>
        
        <button onclick="convertFile()">üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ XML</button>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        // =====================================
        // –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
        // =====================================
        function log(message) {
            const logDiv = document.getElementById('log');
            logDiv.style.display = 'block';
            logDiv.innerHTML += message + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // =====================================
        // –ì–ï–ù–ï–†–ê–¢–û–† XML –î–õ–Ø POHODA
        // =====================================
        async function generatePohodaXML(fileContent) {
            log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é XML –¥–ª—è Pohoda...');
            
            try {
                // –ü–ê–†–°–ò–ù–ì CSV
                log('‚öôÔ∏è –ü–∞—Ä—Å–∏–º CSV –¥–∞–Ω–Ω—ã–µ...');
                const lines = fileContent.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
                
                log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ' + data.length);
                
                // –ì–†–£–ü–ü–ò–†–û–í–ö–ê –ü–û –ù–û–ú–ï–†–ê–ú –î–û–ö–£–ú–ï–ù–¢–û–í
                log('üìã –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä–∞–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤...');
                const documents = {};
                
                data.forEach(row => {
                    const number = row.number;
                    if (number && row.sum && parseFloat(row.sum) > 0 && !row.stornoNumber) {
                        if (!documents[number]) {
                            documents[number] = [];
                        }
                        documents[number].push(row);
                    }
                });
                
                const validDocs = Object.keys(documents);
                log('‚úÖ –í–∞–ª–∏–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + validDocs.length);
                
                // –°–û–ó–î–ê–ù–ò–ï XML
                log('üîß –°–æ–∑–¥–∞–µ–º XML —Å—Ç—Ä—É–∫—Ç—É—Ä—É...');
                
                const timestamp = Date.now();
                let xml = `<?xml version="1.0" encoding="UTF-8"?>
<dat:dataPack id="IMPORT_${timestamp}" ico="12345678" application="StwPop" version="2.0" note="Import z CSV souboru"
    xmlns:dat="http://www.stormware.cz/schema/version_2/data.xsd"
    xmlns:inv="http://www.stormware.cz/schema/version_2/invoice.xsd" 
    xmlns:typ="http://www.stormware.cz/schema/version_2/type.xsd">
`;

                let processedCount = 0;
                
                // –û–ë–†–ê–ë–û–¢–ö–ê –ö–ê–ñ–î–û–ì–û –î–û–ö–£–ú–ï–ù–¢–ê
                validDocs.forEach(docNumber => {
                    const items = documents[docNumber];
                    const firstItem = items[0];
                    
                    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–∞—Ç—ã –∏–∑ DD.MM.YYYY –≤ YYYY-MM-DD
                    const dateParts = firstItem.datetime.split(' ')[0].split('.');
                    const isoDate = `${dateParts[2]}-${dateParts[1]}-${dateParts[0]}`;
                    
                    xml += `
    <!-- Dokument ƒç. ${docNumber} -->
    <dat:dataPackItem id="${docNumber}" version="2.0">
        <inv:invoice version="2.0">
            <inv:invoiceHeader>
                <inv:invoiceType>issuedInvoice</inv:invoiceType>
                <inv:number>
                    <typ:numberRequested>${docNumber}</typ:numberRequested>
                </inv:number>
                <inv:date>${isoDate}</inv:date>
                <inv:dateAccounting>${isoDate}</inv:dateAccounting>
                <inv:dateDue>${isoDate}</inv:dateDue>
                <inv:text>Prodej</inv:text>
                <inv:paymentType>
                    <typ:paymentType>cash</typ:paymentType>
                </inv:paymentType>
                <inv:account>
                    <typ:id>1</typ:id>
                </inv:account>
                <inv:symConst>0308</inv:symConst>
            </inv:invoiceHeader>
            <inv:invoiceDetail>`;
                    
                    let totalPrice = 0;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–∞
                    items.forEach(item => {
                        if (item.name && parseFloat(item.price || 0) > 0) {
                            const unitPrice = parseFloat(item.price);
                            const quantity = parseFloat(item.amount || 1);
                            const linePrice = parseFloat(item.sumLine || unitPrice * quantity);
                            const priceWithVAT = Math.round(linePrice * 1.21 * 100) / 100;
                            
                            totalPrice += linePrice;
                            
                            // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
                            const safeName = item.name
                                .replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;')
                                .replace(/"/g, '&quot;')
                                .replace(/'/g, '&#39;');
                            
                            xml += `
                <inv:invoiceItem>
                    <inv:text>${safeName}</inv:text>
                    <inv:quantity>${quantity}</inv:quantity>
                    <inv:unit>ks</inv:unit>
                    <inv:coefficient>1</inv:coefficient>
                    <inv:payVAT>true</inv:payVAT>
                    <inv:rateVAT>high</inv:rateVAT>
                    <inv:homeCurrency>
                        <typ:unitPrice>${unitPrice}</typ:unitPrice>
                        <typ:price>${linePrice}</typ:price>
                        <typ:priceVAT>${priceWithVAT}</typ:priceVAT>
                    </inv:homeCurrency>
                </inv:invoiceItem>`;
                        }
                    });
                    
                    const totalPriceWithVAT = Math.round(totalPrice * 1.21 * 100) / 100;
                    
                    xml += `
            </inv:invoiceDetail>
            <inv:invoiceSummary>
                <inv:homeCurrency>
                    <typ:priceNone>0</typ:priceNone>
                    <typ:priceLow>0</typ:priceLow>
                    <typ:priceLowVAT>0</typ:priceLowVAT>
                    <typ:priceHigh>${totalPrice}</typ:priceHigh>
                    <typ:priceHighVAT>${totalPriceWithVAT}</typ:priceHighVAT>
                    <typ:round>
                        <typ:priceRound>0</typ:priceRound>
                    </typ:round>
                </inv:homeCurrency>
            </inv:invoiceSummary>
        </inv:invoice>
    </dat:dataPackItem>`;
                    
                    processedCount++;
                });
                
                xml += `

</dat:dataPack>`;
                
                // –†–ï–ó–£–õ–¨–¢–ê–¢
                log('üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                log('üìÑ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + processedCount);
                log('üìÅ –†–∞–∑–º–µ—Ä XML —Ñ–∞–π–ª–∞: ' + Math.round(xml.length / 1024) + ' KB');
                
                return {
                    xmlContent: xml,
                    processedDocuments: processedCount,
                    totalSize: xml.length
                };
                
            } catch (error) {
                log('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message);
                throw error;
            }
        }

        // =====================================
        // –§–£–ù–ö–¶–ò–Ø –°–ö–ê–ß–ò–í–ê–ù–ò–Ø –§–ê–ô–õ–ê
        // =====================================
        function downloadXML(xmlContent, fileName = 'pohoda_import.xml') {
            log('üíæ –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª: ' + fileName);
            
            const blob = new Blob([xmlContent], { 
                type: 'application/xml;charset=utf-8' 
            });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(link.href);
            
            log('‚úÖ –§–∞–π–ª —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
        }

        // =====================================
        // –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ö–û–ù–í–ï–†–¢–ê–¶–ò–ò
        // =====================================
        async function convertFile() {
            try {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                
                if (!file) {
                    alert('‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!');
                    return;
                }
                
                log('üîÑ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é —Ñ–∞–π–ª–∞: ' + file.name);
                
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
                const fileContent = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file, 'UTF-8');
                });
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º XML
                const result = await generatePohodaXML(fileContent);
                
                // –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
                const outputFileName = `pohoda_import_${new Date().toISOString().slice(0,10)}.xml`;
                downloadXML(result.xmlContent, outputFileName);
                
                log('üèÅ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
                log('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:');
                log('   - –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: ' + result.processedDocuments);
                log('   - –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ' + Math.round(result.totalSize / 1024) + ' KB');
                
            } catch (error) {
                log('üí• –û—à–∏–±–∫–∞ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏: ' + error.message);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }
    </script>
</body>
</html>
